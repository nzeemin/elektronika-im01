
; Вход по включению питания
020000  MOV     #003000, 177760
; Точка входа для пересброса - прерывание по вектору 4 (RPLY), 10 (резервный код команды) / 24 (ACLO)
020006  MOV     #000200, SP
020012  RESET   
020014  MTPS    #000340
020020  CLR     000076
020024  MOV     #020332, 000004     ; Адрес прерывания по вектору 4 (RPLY)
020032  MOV     #000340, 000006     ; PSW
020040  MOV     #020052, R0
020044  MOV     #063000, 177750
020052  MOV     #030561, 164004
020060  MOV     #000037, 164060
020066  CLR     164074	            ; Очищаем регистр Д
020072  MOV     #020000, R0
020076  MOV     #020000, R1
020102  MOV     #000200, R5
020106  CALL    023630	            ; Проверить контрольную сумму
020112  MOV     #040000, R0
020116  MOV     #020000, R1
020122  CALL    023630              ; Проверить контрольную сумму
020126  MOV     #000200, R0
020132  MOV     #001600, R1
020136  CALL    023660              ; Заполнить
020142  MOV     #002000, R0
020146  MOV     #002000, R1
020152  CALL    023660		    ; Заполнить
020156  BIT     #000377, 164074
020164  BNE     020072	            ; КС не совпала - на повторную проверку
; Очистка памяти
020166  MOV     #000200, R0
020172  CLR     (R0)+
020174  CMP     R0, #004000
020200  BLT     020172
;
020202  MOV     #020006, R0
020206  MOV     R0, 000004          ; Адрес прерывания по вектору 4 - RPLY
020212  MOV     R0, 000010          ; Адрес прерывания по вектору 10 - резервный код команды
020216  MOV     R0, 000024          ; Адрес прерывания по вектору 24 - ACLO
020222  MOV     #000500, 164072
020230  MOV     #020424, 000100	    ; Адрес прерывания по вектору 100 - EVNT
020236  MOV     #000340, 000102	    ; PSW
020244  MOV     #021536, 000222
020252  MOV     #021466, 000224
020260  CLRB    000212
020264  CALL    022012
020270  MOVB    #000001, 000203
020276  MOVB    #000001, 000204
020304  MOVB    #000002, 001124
020312  MOV     #021432, 000224
020320  MTPS    #000000
020324  INC     003420
020330  BR      020324
020332  MOVB    #000077, 000076
020340  MOV     R0, (SP)
020342  RTI     
; Подпрограмма
020344  INCB    000214
020350  ASRB    000212
020354  BNE     020370
020356  MOVB    #000040, 000212
020364  CLRB    000214
020370  MOVB    000214, R1
020374  CLR     164074              ; Стираем регистр Д
020400  BIC     #000077, 164060
020406  BISB    000212, 164060      ; Выставляем бит для опроса клавиатуры и записи индикаторов
020414  MOVB    000214(R1), 164074  ; Пишем значение индикатора - в регистр Д
020422  RETURN  
; Прерывание по вектору 100 - EVNT
020424  CALL    020344
020430  MOV     164076, R0          ; Читаем ряд с клавиатуры
020434  SWAB    R0
020436  BIC     #177760, R0
020442  BEQ     020600
020444  MOVB    000203(R1), R3
020450  BIC     #177760, R3
020454  CMP     R0, R3
020456  BEQ     020576
020460  MOV     R5, -(SP)
020462  CLR     R5
020464  CALL    034210
020470  MOV     (SP)+, R5
020472  CLR     164074              ; Стираем регистр Д
020476  MOVB    R0, 000203(R1)
020502  ASL     R1
020504  ASL     R1
020506  DEC     R1
020510  INC     R1
020512  ASR     R0
020514  BNE     020510
020516  MOVB    020670(R1), R1      ; Берём байт из таблицы клавиш
020522  BEQ     020576
020524  MOV     R1, R0
020526  BIC     #177770, R0
020532  CLR     000226
020536  CALL    @000224
020542  MOV     000222, R2
020546  MOV     #021536, 000222
020554  ASR     R1
020556  ASR     R1
020560  BIC     #177701, R1
020564  MOV     #021466, 000224
020572  CALL    @020720(R1)
020576  RTI     
;
020600  CMPB    000203, #000010
020606  BNE     020620
020610  TST     R1
020612  BNE     020620
020614  CALL    021432
020620  MOVB    000203(R1), R3
020624  BEQ     020576


; Таблица клавиш
020670  .BYTE   020, 010, 040, 120, 160, 000, 030, 050  ; ·· Pp··(
        .BYTE   067, 066, 065, 064, 070, 170, 130, 150  ; 76548xXh
        .BYTE   100, 140, 110, 000, 063, 062, 061, 060  ; @`H·3210


; Подпрограмма: подсчёт контрольной суммы
;   R0 = адрес откуда; R1 = сколько слов
023630  BIC     R5, 164074          ; стираем бит в регистре Д
023634  CLR     R2
023636  ADD     (R0)+, R2
023640  DEC     R1
023642  SOB     R1, 023636
023644  TST     R2                  ; Получилось 0 ?
023646  BEQ     023654              ; да, выходим
023650  BIS     R5, 164074          ; нет, ставим бит в регистр Д
023654  ASR     R5                  ; сдвигаем индикаторный бит
023656  RETURN  
;
023660  BIC     R5, 164074
023664  MOV     #000001, -(SP)
023670  MOV     R0, R3
023672  MOV     R1, R4
023674  MOV     (SP), R2
023676  MOV     R3, R0
023700  MOV     R4, R1
023702  MOVB    R2, (R0)+
023704  ASLB    R2
023706  BNE     023712
023710  INC     R2
023712  SOB     R1, 023702
023714  MOV     (SP), R2
023716  MOV     R3, R0
023720  MOV     R4, R1
023722  CMPB    R2, (R0)+
023724  BEQ     023732
023726  BIS     R5, 164074
023732  ASLB    R2
023734  BNE     023740
023736  INC     R2
023740  SOB     R1, 023722
023742  ASLB    (SP)
023744  BNE     023674
023746  TST     (SP)+
023750  BR      023654
023752  CALL    023766
023756  CLRB    000211
023762  JMP     021432
023766  MOV     #111111, 001014
023774  MOV     #111111, 001110
024002  RETURN  
